import React, { useState, useEffect, useRef } from 'react';
import { Printer, RefreshCw, Settings, FileText, CheckCircle2, Info } from 'lucide-react';

const App = () => {
  // 設定狀態
  const [config, setConfig] = useState({
    difficulty: 'easy', // easy, medium, hard, custom
    operators: ['+'],
    rangeMin: 1,
    rangeMax: 20,
    questionCount: 20,
    setCount: 1,
    showAnswers: true,
    fontSize: 'text-2xl',
  });

  const [examSets, setExamSets] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);

  // 產生題目邏輯
  const generateMathSets = () => {
    setIsGenerating(true);
    const newSets = [];

    for (let s = 0; s < config.setCount; s++) {
      const questions = [];
      for (let q = 0; q < config.questionCount; q++) {
        const op = config.operators[Math.floor(Math.random() * config.operators.length)];
        let num1, num2, answer;

        // 根據運算符產生合理的數字
        if (op === '+') {
          num1 = Math.floor(Math.random() * (config.rangeMax - config.rangeMin + 1)) + config.rangeMin;
          num2 = Math.floor(Math.random() * (config.rangeMax - config.rangeMin + 1)) + config.rangeMin;
          answer = num1 + num2;
        } else if (op === '-') {
          num1 = Math.floor(Math.random() * (config.rangeMax - config.rangeMin + 1)) + config.rangeMin;
          num2 = Math.floor(Math.random() * (num1 - config.rangeMin + 1)) + config.rangeMin; // 確保不出現負數
          answer = num1 - num2;
        } else if (op === '×') {
          const maxFactor = config.difficulty === 'easy' ? 9 : 20;
          num1 = Math.floor(Math.random() * maxFactor) + 1;
          num2 = Math.floor(Math.random() * maxFactor) + 1;
          answer = num1 * num2;
        } else { // ÷
          num2 = Math.floor(Math.random() * 9) + 1;
          answer = Math.floor(Math.random() * 10) + 1;
          num1 = num2 * answer;
        }

        questions.push({ id: q, num1, num2, op, answer });
      }
      newSets.push({ id: s, questions });
    }
    setExamSets(newSets);
    setIsGenerating(false);
  };

  // 初始產生
  useEffect(() => {
    generateMathSets();
  }, []);

  const handlePrint = () => {
    window.print();
  };

  const updateDifficulty = (diff) => {
    let newConfig = { ...config, difficulty: diff };
    if (diff === 'easy') {
      newConfig = { ...newConfig, rangeMax: 10, operators: ['+'], questionCount: 12 };
    } else if (diff === 'medium') {
      newConfig = { ...newConfig, rangeMax: 50, operators: ['+', '-'], questionCount: 20 };
    } else if (diff === 'hard') {
      newConfig = { ...newConfig, rangeMax: 100, operators: ['+', '-', '×'], questionCount: 24 };
    }
    setConfig(newConfig);
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center">
      {/* 控制面板 - 列印時隱藏 */}
      <div className="w-full max-w-4xl bg-white p-6 shadow-md mb-8 mt-4 rounded-lg print:hidden no-print">
        <div className="flex items-center gap-2 mb-4 text-blue-600">
          <Settings size={24} />
          <h1 className="text-2xl font-bold">數學練習產生器設定</h1>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {/* 難度選擇 */}
          <div className="space-y-2">
            <label className="block font-semibold text-gray-700">選擇難度</label>
            <div className="flex flex-wrap gap-2">
              {['easy', 'medium', 'hard'].map((d) => (
                <button
                  key={d}
                  onClick={() => updateDifficulty(d)}
                  className={`px-4 py-2 rounded-full border transition-all ${
                    config.difficulty === d ? 'bg-blue-500 text-white border-blue-600' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  {d === 'easy' ? '簡單 (10內)' : d === 'medium' ? '一般 (50內)' : '進階 (100內)'}
                </button>
              ))}
            </div>
          </div>

          {/* 運算符號 */}
          <div className="space-y-2">
            <label className="block font-semibold text-gray-700">運算符號</label>
            <div className="flex gap-4">
              {['+', '-', '×', '÷'].map((op) => (
                <label key={op} className="flex items-center gap-1 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={config.operators.includes(op)}
                    onChange={(e) => {
                      const ops = e.target.checked 
                        ? [...config.operators, op] 
                        : config.operators.filter(o => o !== op);
                      if (ops.length > 0) setConfig({ ...config, operators: ops });
                    }}
                    className="w-5 h-5"
                  />
                  <span className="text-xl">{op}</span>
                </label>
              ))}
            </div>
          </div>

          {/* 份數與答案 */}
          <div className="space-y-2">
            <label className="block font-semibold text-gray-700">產生份數 (組)</label>
            <input
              type="number"
              min="1"
              max="10"
              value={config.setCount}
              onChange={(e) => setConfig({ ...config, setCount: parseInt(e.target.value) || 1 })}
              className="w-full p-2 border rounded-md"
            />
            <label className="flex items-center gap-2 mt-2 cursor-pointer">
              <input
                type="checkbox"
                checked={config.showAnswers}
                onChange={(e) => setConfig({ ...config, showAnswers: e.target.checked })}
                className="w-5 h-5"
              />
              <span className="font-semibold text-gray-700">附上答案頁</span>
            </label>
          </div>
        </div>

        <div className="mt-6 flex gap-4">
          <button
            onClick={generateMathSets}
            className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-700 transition-colors"
          >
            <RefreshCw size={20} /> 重新產生題目
          </button>
          <button
            onClick={handlePrint}
            className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors"
          >
            <Printer size={20} /> 列印練習卷 (A4)
          </button>
        </div>
        
        <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800 flex gap-2">
          <Info size={16} className="shrink-0" />
          <p>小提示：點擊「列印」後，在目的地選擇「另存為 PDF」即可下載保存。字體特別加大，適合長輩練習。</p>
        </div>
      </div>

      {/* A4 預覽區域 */}
      <div className="w-full max-w-[210mm] space-y-8 mb-10">
        {examSets.map((set, setIdx) => (
          <div key={`set-${set.id}`} className="flex flex-col gap-8">
            {/* 題目頁 */}
            <div className="bg-white p-[20mm] shadow-lg w-[210mm] min-h-[297mm] mx-auto page-break-after-always">
              <div className="border-b-4 border-black pb-4 mb-8 flex justify-between items-end">
                <div>
                  <h2 className="text-4xl font-black mb-2">每日腦力運動 - 數學練習單</h2>
                  <p className="text-gray-600">日期：____ 年 ____ 月 ____ 日</p>
                </div>
                <div className="text-right">
                  <p className="text-xl font-bold">第 {setIdx + 1} 份</p>
                  <p className="text-gray-500">姓名：__________</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-x-12 gap-y-8">
                {set.questions.map((q, idx) => (
                  <div key={idx} className="flex items-center text-4xl border-b border-gray-200 pb-4 h-24">
                    <span className="w-12 text-gray-400 text-lg mr-2">({idx + 1})</span>
                    <div className="flex-1 flex justify-between items-center pr-4 font-mono tracking-wider">
                      <span>{q.num1} {q.op} {q.num2} = </span>
                      <div className="w-24 h-16 border-2 border-gray-300 rounded-md"></div>
                    </div>
                  </div>
                ))}
              </div>

              <div className="mt-auto pt-10 text-center text-gray-400 text-sm">
                加油！每天練習 10 分鐘，大腦更靈活。
              </div>
            </div>

            {/* 答案頁 (如果勾選) */}
            {config.showAnswers && (
              <div className="bg-white p-[20mm] shadow-lg w-[210mm] min-h-[297mm] mx-auto page-break-after-always border-t-8 border-green-500">
                <div className="flex items-center gap-2 mb-8 text-green-700">
                  <CheckCircle2 size={32} />
                  <h2 className="text-3xl font-bold">解答頁 (第 {setIdx + 1} 份)</h2>
                </div>
                
                <div className="grid grid-cols-3 gap-8">
                  {set.questions.map((q, idx) => (
                    <div key={`ans-${idx}`} className="text-2xl border-b p-2 flex justify-between">
                      <span className="text-gray-400">({idx + 1})</span>
                      <span className="font-bold">{q.num1} {q.op} {q.num2} = <span className="text-red-600">{q.answer}</span></span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>

      <style>{`
        @media print {
          body { background: white !important; padding: 0 !important; }
          .no-print { display: none !important; }
          .page-break-after-always { page-break-after: always; }
          .shadow-lg { shadow: none !important; }
          .bg-gray-100 { background: white !important; }
          @page {
            size: A4;
            margin: 0;
          }
        }
      `}</style>
    </div>
  );
};

export default App;
